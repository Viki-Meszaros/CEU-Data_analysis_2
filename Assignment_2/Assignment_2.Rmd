---
title: "Predictive analysis on Titanic data"
author: "Viktoris Meszaros"
date: 2020-12-30
output: 
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, warning=F, message= F}
library(kableExtra)
library(tidyverse)
library(ggthemes)
library(stargazer)
require(scales)
library(lspline)
library(ggcorrplot)

df <- read.csv("https://raw.githubusercontent.com/Viki-Meszaros/CEU-Data_analysis_2/main/Assignment_2/Data/Clean/Titanic_clean.csv")

df2  <- read.csv("https://raw.githubusercontent.com/Viki-Meszaros/CEU-Data_analysis_2/main/Assignment_2/Data/Raw/Titanic_raw.csv", na.strings = c("", "NA"))
df$X <- NULL

```

# Abstract

# Topic
I chose a really interesting topic for my analysis. It was the tragedy of the luxury steamship called Titanic. As most of you already know, Titanic was one of the first ocean liners and the largest ship in the world at that time. It was traveling from Southampton to New York when an unexpected accident happened. It bumped into an iceberg and sank in the early hours of April 15, 1912. This was one of the deadliest maritime catastrophes of all time leading to the death of more than 1500 people (out of the 2224 on board). 

# Aim of the research
In this project my aim will be to build a predictive model that helps to find out what sort of people were more likely to survive the sinking of the Titanic than others. If there are some factors that increased the probability for someone to survive. 


## Data collection
The data I used for my research I found on the website [Kaggle.com](https://www.kaggle.com/c/titanic/data?select=test.csv) . It contains 819 observations (and 418 in a test file). This is because this data was uploaded as part of a machine learning competition where it is needed to have a train and than a test set. I could not join these two samples, as for the test data the binary values of if the passenger survived or not were missing, so I would not be able to build a model on that. 
On the Titanic there were 2435 people when it sunk, out of which 1320 were passengers and the remaining 892 crew members. In our data set we have data about 819 passengers which is more than 60% of the total population. We know that our sample was created in a totally random manner so we can assume that it is representative. 
There were some missing values in my data for some observation representing 8% of our data. Most of the missing values are in Cabin numbers and Age. 

```{r, echo= F, warning= F, message= F}
nas <- NULL
for (i in 1:ncol(df2)) {
  nas  <- c(nas, sum(is.na(df2[ , i])))
}

num_NAs <- as_tibble(cbind(names(df2), nas))
colnames(num_NAs) <- c("Variable", "Number_of_NAs")

knitr::kable(num_NAs %>%  arrange( desc(Number_of_NAs)) %>% head(3) )

```

As Age is an important variable for my analysis I did some imputation to replace NA values. As the distribution of age was skewed to the right instead of mean value I used the median to decrease the bias. I calculated the different median age values for males and females in different social groups as I found out from the data that women were younger on Titanic and people in the 1st class were older on average compared to the ones in lower social classes. The following table shows the different values I imputed for the different groups.


```{r, echo= F, warning= F, message= F, out.width= "50%"}

age <- df2 %>% 
  group_by(Sex, Pclass) %>%
  summarise("average age" = round(median(Age, na.rm = T)))

knitr::kable(age)
```

Although this imputation helps to get rid of missing values it also causes bias in my estimation as these values are just my assumptions instead of actual values. According to data quality there is one more issue to mention. There is a variable called Pclass which shows the ticket class a given passenger had. From this we will assume that these passengers belong to that socio-economic layer. This variable is interesting as out initial assumption is that people who belong to the 1st class will have a higher probability of survival as they were more important is the eyes of crew during the evacuation process. This assumption may not be true if for example a really wealthy person from social class 1 bought a 2nd or 3rd class ticket as he/she does not care about luxury during his/her travel. 
We should also keep in mind the this tragedy happened in 1912 when administration was not even close to perfect and due to this our data may contain some measurement errors due to personal mistakes or lost documents.

## Data cleaning

During the data cleaning process I dealt with missing values. I excluded Cabin variable as 77% of the values were missing. For age as I already outlined I made imputation as I considered it an important variable for my prediction. Last but not least for Embarked there were 2 missing values. I decided to do some extra research as I knew the name of the passengers. I found out that both of them embarked in Southhampton, so I filled in this values which solved the problem. After dealing with missing values I also looked at extreme values. I only had two continuous variables Age and Fare, so I only had to look for extremes here. For Age the distribution looked close to normal with no unexpected extreme values. For Fare the distribution was rather skewed to the right, due to some extreme values. I had a closer look on these, and realized these were not errors but the most expensive  tickets so I decided not to exclude any values.
I also had to do some transformations on categorical variables to make them appropriate for the modeling. I had some data about how many parent, siblings, spouses or children a passenger had on board with them. From this I decided to create a binary variable Travel_alone which was was if the person was alone on board and 0 if he/she had some family members with them. I though this variable will be helpful as it was said that during the rescue families, especially women or men with children had higher priority to get on the boats. For social class and embark location I created dummy variables with n-1 categories always leaving out one category as a base. For more information about my data cleaning process please check my [data_cleaning.R](https://github.com/Viki-Meszaros/CEU-Data_analysis_2/blob/main/Assignment_2/Codes/1_data_cleaning.R) available in my Github repository. 

**For my model I will use:**

- Survived (0 if no, 1 if yes) as the dependent(*y*) variable
- Sex, Age, Social Class, Embarked, Ticket price and if someone traveled alone or with family are going to be the right hand side(*x*) variables for my model

# Patterns of association

After looking at all the patterns of association between my outcome variable and all the explanatory variables I could come up with some interesting assumptions. (For all the graphs of the patterns of association please look at the Appendix section)

- Women had more chance to survived then men.
- People in higher social class had higher probability of survival. Someone in socio-economic class 3 had the worst chance.
- Those who embarked in Southhampton died with higher probability and those who got on board in Cherboug had the highest chance of surviving.
- Someone who traveled with his/her family also were in a better situation as for them survival was more likely compared to someone traveling alone.
- The probability to survive decreased with age for people below 25 and above 32, but increased between these two
- As the price people paid for the travel increased, so did the probability of survival

From the graphs below you can see the patterns of association between the two continuous variables and the dependent variable. Based on this I decided to use a piecewise linear spline for Age and the log transformation for the Fare variable later on.

```{r, echo= F, message= F, warning= F, out.width= "33%"}
#AGE
ggplot( df , aes( x = Age , y = Survived ) )+
  stat_summary_bin( fun = 'mean' , binwidth = 7, 
                    geom = 'point',  size = 2 ) +
  labs( x = 'Age' , y = 'Survived' )+
  theme(legend.position = "none")+
  geom_smooth(method="loess",formula = y~x, color = "cyan4") +
  labs(title = "Pattern od association between age and survival (bins of 7 age)",x = "Age",y = "Survived / Predicted probability of ")+
  theme_calc()

#FARE
df %>% 
  ggplot(aes(x = Fare, y = Survived)) +
  stat_summary_bin( fun = 'mean' , binwidth = 10, 
                    geom = 'point',  size = 2 ) +
  geom_smooth(method = "loess", color = "cyan4") +
  labs(title = "Pattern od association between fare and survival (bins of 10 USD)", x = "Fare",y = "Survived / Predicted probability of ")+
  theme_calc()

# with binned values
df %>% 
  ggplot(aes(x = Fare, y = Survived)) +
  stat_summary_bin( fun = 'mean' , binwidth = 0.5, 
                    geom = 'point',  size = 2 ) +
  scale_x_continuous( trans = "log") +
  geom_smooth(method = "loess", color = "cyan4") +
  labs(title = "Pattern od association between ln(Far) and survival (bins of 0.5 ln(fare))", x = "ln(Fare)",y = "Survived / Predicted probability of ")+
  theme_calc()
```

## Correlation between variables

Before building my model I checked the correlation between my variables. From this graph you can see that there is only one variable pair whose correlation is high and that is Pclass and Pclass_1. This is what we expect as they measure the same thing. We have moderate correlation between Pclass and Fare as Pclass measures the class of the ticket its price should increase if it belongs to a higher class.Also there is moderate correlation between Female and Survived meaning that the sex of the passenger strongly correlated with the probability of survival. For our model the only correlation that matters is between the fare and Pclass. Due to this I decided not to use fare in my model only social class. This also made my final model simpler, with keeping its power.

```{r, echo= F, warning= F, message= F, out.width= "50%"}
numeric_df <- keep( df , is.numeric )
corr <- round(cor( 
  keep(df, is.numeric)), 3)

  ggcorrplot(corr)

```

# Model choice 
As I did prediction I decided to split my data to two sets. First to a training set and then a test set to do robustness check in the end. I put randomly 80% of my observations to train and left the remaining 20% in a test set. 

```{r, echo= F, warning= F, message= F}
set.seed(123)
dt <- sort(sample(seq_len(nrow(df)), nrow(df)*.8))

test <- df[-dt,]
train <- df[dt, ]

train <- train %>% mutate( ln_fare= log( Fare ))
ttrain <- train %>% filter(Fare != 0)
```



```{r}
model_formula <- formula( Survived ~ Female + Pclass_1 + Pclass_2 + lspline(Age, c(27, 32)) 
                           + Travel_alone + Q + C )
#### LPM
lpm <-lm( model_formula , data=ttrain)
summary(lpm, vcov=sandwich )

ttrain$pred_lpm <- predict(lpm)

summary(ttrain$pred_lpm)

ggplot( ttrain , aes( x = pred_flpm) ) +
  geom_histogram( fill = 'navyblue' , color = 'grey90', binwidth = 0.08)

ttrain <- ttrain %>% 
  mutate( pred_lpm_100 = ntile(pred_lpm, 100) )

#### LOGIT
logit <- glm( model_formula , data=ttrain, family=binomial(link="logit") )
summary(logit)
glance(logit)

# predicted probabilities 
ttrain$pred_logit <- predict.glm(logit, type="response")
summary(tdf$pred_logit)

# Calculate logit marginal differences
logit_marg <- logitmfx( model_formula, data=train, atmean=FALSE, robust = T)
print(logit_marg)


#### PROBIT
probit <- glm( model_formula , data = tdf , family=binomial(link="probit") )
summary(probit)

# predicted probabilities 
ttrain$pred_probit<- predict.glm( probit , type = "response" )
summary( ttrain$pred_probit )

# probit marginal differences
probit_marg <- probitmfx(  model_formula, data=ttrain, atmean=FALSE, robust = T)
print( probit_marg )

```




##






## APPENDIX

## I. Data descriptives

### Continuous variables

```{r, echo= F, message= F, warning= F, out.width= "40%"}

# AGE
    ggplot(df2, aes(x = Age)) +
    geom_histogram(aes(y = ..density..), fill = "cyan4", color = "white", alpha = 0.6, binwidth = 5) +
    geom_density(aes( y = ..density.. ), color = "cyan4", bw = 5, size = 1) +
    theme_calc() +
    labs(title = "Density plot for Age", x = "Age", y = "")

# FARE  
    ggplot(df2, aes(x = Fare)) +
    geom_histogram(aes(y = ..density..), fill = "cyan4", color = "white", alpha = 0.6, binwidth = 15) +
    geom_density(aes( y = ..density.. ), color = "cyan4", bw = 15, size = 1) +
    theme_calc() +
    labs(title = "Density plot for Fare", x = "Ticket price", y = "")
```

### Summary statistics for continuous variables

```{r, echo= F, warning= F, message= F}
source("https://raw.githubusercontent.com/Viki-Meszaros/CEU-Data_analysis_2/main/Assignment_2/Codes/sum_stat.R")
 
    desc_stat <- sum_stat( df2 , var_names = c('Age', 'Fare'),
                           stats = c('min','1st_qu.', 'median','mean', '3rd_qu','max','sd') )
knitr::kable(desc_stat)
```



### Categorical variables 

```{r, echo= F, message= F, warning= F, out.width= "33%"}
# SEX
    ggplot(df2, aes(x = Sex)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Sex of the passengers")

# SURVIVED
    ggplot(df2, aes(x = Survived)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Number of passengers who survived and who died", x="", y="") +
    scale_x_continuous(breaks = c(0,1) ,labels = c("0" = "Died", "1" = "Survived"))
    
# TICKET CLASS
    ggplot(df2, aes(x = Pclass)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Different ticket classes", x="", y="") +
    scale_x_continuous(breaks = c(1, 2, 3) ,labels = c("1" = "1st Class", "2" = "2nd Class", "3" = "3rd Class"))
    
# EMBARKED  
    ggplot(df2, aes(x = Embarked)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Different ticket classes", x="", y="")
    
# NUMBER OF PARENTS OR CHILDREN
    ggplot(df2, aes(x = Parch)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Number of parents and/or children a passenger has", x="", y="")
    
# NUMBER OF SIGLINGS
    ggplot(df2, aes(x = SibSp)) +
    geom_bar(fill = "cyan4", alpha = 0.6) +
    theme_calc() +
    labs(title = "Number of siblings a passenger has", x="", y="")
    

```



## II. Pattern of association 

### Pattern of association

```{r, echo= F, warning= F, message= F, out.width= "45%"}
#SEX
lpm1_sex <- lm(Survived ~ Female, data=df)
df$pred1 <- predict(lpm1_sex)

df <- df %>%
  group_by(Female, Survived) %>%
  mutate(weight = n())  %>%
  mutate(weight_2=(weight/1000))

ggplot(data = df) +
  geom_line(aes(x = Female, y = pred1),  size = 0.8, color = "cyan3", alpha = 0.6 ) +
  geom_point(aes(x = Female, y = pred1), size = 3, color = "cyan4",  shape = 16) +
  geom_point(aes(x = Female, y = Survived, size=weight_2), color = "purple3", shape = 16, alpha=0.8, show.legend=F, na.rm=TRUE)  +
  labs(x = "Female",y = "Survived / Predicted probability of ")+
  coord_cartesian(xlim = c(0, 1), ylim=c(0,1)) +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1))+
  scale_x_continuous(limits = c(0,1), breaks = c(0,1), labels = c("0" = "Male", "1" = "Female"))+
  theme_calc() 

## PCLASS
lpm2_pclass <- lm(Survived ~ Pclass_1 + Pclass_2, data = df)
df$pred2 <- predict(lpm2_pclass)

df <- df %>%
  group_by(Pclass, Survived) %>%
  mutate(weight = n())  %>%
  mutate(weight_2=(weight/1000))

ggplot(data = df) +
  geom_line(aes(x = Pclass, y = pred2),  size = 0.8, color = "cyan3", alpha = 0.6 ) +
  geom_point(aes(x = Pclass, y = pred2), size = 3, color = "cyan4",  shape = 16) +
  geom_point(aes(x = Pclass, y = Survived, size=weight_2), color = "purple3", shape = 16, alpha=0.8, show.legend=F, na.rm=TRUE)  +
  labs(x = "Socio-economic class",y = "Survived / Predicted probability of ")+
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1))+
  scale_x_continuous(breaks = c(1, 2, 3) , labels = c("1" = "1st Class", "2" = "2nd Class", "3" = "3rd Class" )) +
  theme_calc() 

## EMBARKED
lpm3_embarked <- lm(Survived ~ C + Q, data = df)
df$pred3 <- predict(lpm3_embarked)

df <- df %>%
  group_by(Embarked, Survived) %>%
  mutate(weight = n())  %>%
  mutate(weight_2=(weight/1000))

ggplot(data = df) +
  geom_point(aes(x = Embarked, y = pred3), size = 3, color = "cyan4",  shape = 16) +
  geom_point(aes(x = Embarked, y = Survived, size=weight_2), color = "purple3", shape = 16, alpha=0.8, show.legend=F, na.rm=TRUE)  +
  labs(x = "Embarked in",y = "Survived / Predicted probability of ")+
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1)) +
  scale_x_discrete(labels = c( "Q" = "Queenstown", "S" = "Southhampton", "C" = "Cherbourg")) +
  theme_calc() 

## TRAVEL ALONE
lpm4_travalone <- lm(Survived ~ Travel_alone, data = df)
df$pred4 <- predict(lpm4_travalone)

df <- df %>%
  group_by(Travel_alone, Survived) %>%
  mutate(weight = n())  %>%
  mutate(weight_2=(weight/1000))

ggplot(data = df) +
  geom_line(aes(x = Travel_alone, y = pred4),  size = 0.8, color = "cyan3", alpha = 0.6 ) +
  geom_point(aes(x = Travel_alone, y = pred4), size = 3, color = "cyan4",  shape = 16) +
  geom_point(aes(x = Travel_alone, y = Survived, size=weight_2), color = "purple3", shape = 16, alpha=0.8, show.legend=F, na.rm=TRUE)  +
  labs(x = "Travel Alone",y = "Survived / Predicted probability of ")+
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1))+
  scale_x_continuous(limits = c(0,1), breaks = c(0,1), labels = c("0" = "No", "1" = "Yes"))+
  theme_calc() 

```


















